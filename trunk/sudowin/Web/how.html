<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html 	PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en">
	<head>
		<title>Sudo for Windows</title>
		<link href="css/default.css" rel="stylesheet" type="text/css" />
		<script type="text/javascript" src="scr/default.js"></script>
	</head>
	<body onload="onPageLoad();">
		<div id="divBody">
			
			<script type="text/javascript">
				writerHeader();
			</script>
			
			<div class="divSection">
				<span class="spanSectionHeader">
					Basics
				</span>
				<p class="pSectionText">
					Sudo for Windows is at its core composed of two components -- the server and the client.  
					The client asks the server to escalate the user's privileges, and the server either 
					complies or refuses.
				</p>
				<p class="pSectionText">
					This is obviously a great simplification of how Sudo for Windows works.  To better 
					understand Sudo for Windows we will walk through a step-by-step invocation of sudowin.
				</p>
			</div>
			
			<div class="divSection">
				<span class="spanSectionHeader">
					Callback application
				</span>
				<p class="pSectionText">
					Before we look at the sudowin process, the callback application needs to be 
					explained.  The callback application is necessary on Windows 2000 and Windows XP 
					operating systems because these operating systems do not support the win32 API 
					function 
					<a href="http://msdn.microsoft.com/library/en-us/dllproc/base/createprocesswithtokenw.asp">CreateProcessWithTokenW</a>.	
				</p>
				<p class="pSectionText">
					The sudo server is hosted by a Windows service that is running under the SYSTEM 
					account in order to launch processes on behalf of other users.  However, the 
					process must be launched with ther user's logon token so that the process is 
					launched in the user's desktop context (so the user can see it).  Equally important 
					is loading the user's profile when the process is launched so the process respects 
					the user's new group membership.  Windows 2000 and Windowx XP support launching a 
					process with a logon token with the win32 API function 
					<a href="http://msdn.microsoft.com/library/default.asp?url=/library/en-us/dllproc/base/createprocessasuser.asp">CreateProcessAsUser</a>, 
					but unfortunately this function does not allow you to load the user's profile, meaning 
					that the users new group membership will not be respected.
				</p>
				<p class="pSectionText">
					Enter the callback application.  On Windows 2000 and Windows XP operating systems 
					the sudo server launches the callback application using CreateProcessAsUser so that 
					it will be launched in the user's desktop context.  The callback application then 
					launches the intended command using the .NET Process class, loading the user's 
					profile in the process, allowing the user's new group membership to be respected.
				</p>
				<p class="pSectionText">
					The callback application is not desirable, which is one reason to migrate 
					your desktop to Windows Vista when possible.  Windows Vista and Windows Server 2003  
					support the win32 API function CreateProcessWithTokenW.  This function allows you to 
					launch a process with a logon token and at the same time to load the users's profile.
				</p>
				<p class="pSectionText">
					Under normal circumstances this type of design would be a security hole.  However, 
					Sudo for Windows circumvents this by digitally signing both the sudo server binary and 
					the callback application binary with the same strong name key.  The sudo server 
					verifies with every invocation of a sudo client that the callback application has 
					the same signature as itself and has not been altered in any way.
				</p>
				<p class="pSectionText">
					For this reason the strong name key that was used to sign the shipping versions of 
					the sudo server and callback application binaries is not included with the shipping 
					versions of Sudo for Windows.  Earlier revisions in the source control repository 
					includes a strong name key, but it has since been regenerated and used to resign the 
					binaries.  You are in fact strongly encouraged to generate your own strong name key 
					and use that to resign the binaries, but since most users will probably not take this 
					step the development strong name key will not be made public.
				</p>
			</div>
			
			<div class="divSection">
				<span class="spanSectionHeader">
					Step-by-step
				</span>
				<ol>
					<li>
						Mandy invokes a sudowin client.
					</li>

					<li>
						The client tries to open a secure IPC channel to the server.  If Mandy is not a 
						a member of the configured sudoers group then the client canno open a 
						secure IPC channel to the server and Mandy is not allowed to continue
						<br /><br />
						If the user a member of the configured sudoers group then the process continues.
					</li>
					<li>
						If the secure IPC channel has been established then the server checks to see if Mandy 
						has cached credentials.  If Mandy has cached credentials then the process skips to Step 6.
						<br /><br />
						If Mandy does not have cached credentials then the appropriate response code is returned 
						to the client.
					</li>
					<li>
						The client prompts Mandy to enter her passphrase.  The client sends the Mandy's username, 
						passphrase, and the invoked command to the server.  The passphrase is sent in plain text, but since 
						it is sent over a secure IPC channel, this is ok.
					</li>

					<li>
						The server attempts to verify Mandy's passphrase using, in order, the configured authentication
						plugins.
						<br /><br />
						If server fails to authenticate Mandy then the server responds to the client with the appropriate 
						response code.  If a Mandy fails to authenticate several times in a row she will be locked out for 
						a given amount of time.
						<br /><br />
						The allowed retry count, retry window, and lockout length are all configuration options 
						for the server process.
						<br /><br/>
						If the server successfully authenticates Mandy then her credentials 
						are securely cached in memory for a configurable amount of time and the process continues
					</li>
					<li>
						The server attempts to authorize the invoked command using, in order, the configured 
						authorization plugins.
						<br /><br />
						If the server fails to authorize the command then Mandy the appropriate response code is 
						returned to the client and Mandy is not allowed to continue.
						<br /><br />
						If the command is successfully authorized then the process continue.
					</li>
					<li>
						<span style="color:black; font-weight:bold;">Windows 2000 and Windows XP</span>
						<br /><br />
						The server verifies that the server assembly and the callback assembly are signed 
						with the same strong name key.  If this verification fails then the appropriate 
						response code is returned to the client and Mandy is not allowed to continue.
						<br /><br />
						If the verification is successful then the process continues.
					</li>
					<li>
						The server then uses the .NET port of the Microsoft Windows Terminal Server API 
						(<a href="https://sourceforge.net/projects/wtsapi32net">wtsapi32.net</a>) to enumerate the users 
						logged onto the machine.  Once Mandy is found the server creates a reference to her
						logon token.
					</li>
					<li>
						The server then adds Mandy to the configured privilege escalation group.
					</li>
					<li>
						<span style="font-weight:bold;">Windows 2000 and Windows XP</span>
						<br /><br />
						The server then uses the win32 API function 
						<a href="http://msdn.microsoft.com/library/default.asp?url=/library/en-us/dllproc/base/createprocessasuser.asp">CreateProcessAsUser</a> 
						to invoke the callback application in the security context of Mandy.  The server 
						sends the callback application the Mandy's passphrase and the invoked command and 
						waits for the callback application process to complete before continuing.
						<br /><br />
						<span style="font-weight:bold;">Windows Server 2003 and Windows Vista Beta 2</span>
						<br /><br />
						The server then uses the win32 API function 
						<a href="http://msdn.microsoft.com/library/en-us/dllproc/base/createprocesswithtokenw.asp">CreateProcessWithTokenW</a>
						to start the invoked command.  Once the process is launched with elevated 
						privileges the server removes Mandy from the privileges group.
					</li>
					<li>
						<span style="font-weight:bold;">Windows 2000 and Windows XP</span>
						<br /><br />
						The callback application starts a new process with the command Mandy invoked sudo on using Mandy's
						passphrase.  The callback application specifies that the Mandy's profile should be 
						loaded causing Mandy's new group membership in the privileged group to be respected.
					</li>

					<li>
						<span style="font-weight:bold;">Windows 2000 and Windows XP</span>
						<br /><br />
						The server detects that the callback application has completed and promptly removes Mandy from 
						the privileged group.
					</li>
					<li>
						That is Sudo for Windows in 3 easy steps!
					</li>
				</ol>
			</div>
			<script type="text/javascript">
				writeFooter();
			</script>
		</div>
	</body>
</html>